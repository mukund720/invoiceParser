<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Reader</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.18.0/js/md5.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>


    <style>
        #canvasContainer {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* canvas {
            width: 100%;
            height: auto;
        } */
    </style>
</head>

<body>
    <form id="uploadForm" method="POST" enctype="multipart/form-data">
        <input type="file" name="pdf_file" accept=".pdf" required>
        <input type="submit" value="Upload PDF">
    </form>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-sm-6">

                <div id="textareasContainer">
                    <!-- Textarea boxes will be generated here -->
                </div>
            </div>

            <div class="col-sm-6">
                <div id="canvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let canvas = document.getElementById('pdfCanvas');
        let canvasContainer = document.getElementById('canvasContainer');
        let ctx = canvas.getContext('2d');
        let images = [];
        let startX = 0;
        let startY = 0;
        let endX = 0;
        let endY = 0;
        let isSelecting = false;

        function drawPDF() {
            if (images.length > 0) {
                let img = images[0];
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);
            }
        }
        let uniqueTextAreas = {}; // Store unique text areas
        function createUniqueElement(content, rect,type) {
            let contentHash = hashContent(content); // Calculate a hash of the content
            if (!uniqueTextAreas.hasOwnProperty(contentHash)) {
                let textareasContainer = document.getElementById('textareasContainer');
                let element = null;

                // Check if the content represents a table (you may need to adjust this check based on your requirements)
                if (type=="table") {
                    element = document.createElement(content); // Function to create a table element
                } else {
                    element = document.createElement('textarea');
                    element.value = content;
                }

                uniqueTextAreas[contentHash] = true;
                textareasContainer.appendChild(element);

            }
        }

        

        function sendSelectedSection(section) {
            $.ajax({
                url: '/process_section',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(section),
                success: function (response) {
                    if (response.status) {
                        console.log(response)
                        let rect = response.response[0];
                        createUniqueElement(rect, rect,response.type);
                    }
                    console.log('Retrieved values:', response);
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                }
            });
        }

        function hashContent(content) {
            // Use the MD5 algorithm to generate a hash based on the content
            return md5(content);
        }

        function highlightMatchingSelection(rect, contentRectangles) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPDF();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;

            if (contentRectangles) {
                contentRectangles.forEach(contentRect => {
                    ctx.strokeRect(contentRect.startX, contentRect.startY, contentRect.width, contentRect
                        .height);
                });
            }

            ctx.strokeRect(rect.startX, rect.startY, rect.width, rect.height);
        }



        function highlightSelection(rect) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPDF();

            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(rect.startX, rect.startY, rect.width, rect.height);
        }

        function drawSectionBorder(startX, startY, endX, endY, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, endX - startX, endY - startY);
        }

        canvas.addEventListener('mousedown', (event) => {
            startX = event.clientX - canvas.getBoundingClientRect().left;
            startY = event.clientY - canvas.getBoundingClientRect().top;
            isSelecting = true;
        });

        canvas.addEventListener('mousemove', (event) => {
            if (isSelecting) {
                endX = event.clientX - canvas.getBoundingClientRect().left;
                endY = event.clientY - canvas.getBoundingClientRect().top;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawPDF();
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.strokeRect(startX, startY, endX - startX, endY - startY);
            }
        });

        canvas.addEventListener('mouseup', () => {
            isSelecting = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPDF();
            let section = {
                startX: Math.min(startX, endX),
                startY: Math.min(startY, endY),
                endX: Math.max(startX, endX),
                endY: Math.max(startY, endY),
                croppedImage: canvas.toDataURL('image/jpeg')
            };
            let sectionColor = getNextColor();
            sendSelectedSection(section);
            drawSectionBorder(section.startX, section.startY, section.endX, section.endY, sectionColor);
        });

        $('#uploadForm').submit(function (event) {
            event.preventDefault();
            let formData = new FormData(this);
            $.ajax({
                url: '/process_pdf',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        images = response.images.map(imgBase64 => {
                            let img = new Image();
                            img.onload = function () {
                                drawPDF();
                            };
                            img.src = 'data:image/jpeg;base64,' + imgBase64;
                            return img;
                        });
                    } else {
                        console.error('Error:', response.error);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                }
            });
        });

        function adjustCanvasSize() {
            let containerWidth = canvasContainer.clientWidth;
            let containerHeight = containerWidth * (canvas.height / canvas.width);
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            drawPDF();
        }

        window.addEventListener('resize', adjustCanvasSize);
        adjustCanvasSize();
        let sectionColors = ['red', 'blue', 'green', 'orange', 'purple']; // List of different colors
        let currentColorIndex = 0; // Index of the current color

        function getNextColor() {
            let color = sectionColors[currentColorIndex];
            currentColorIndex = (currentColorIndex + 1) % sectionColors.length;
            return color;
        }
    </script>
</body>

</html>